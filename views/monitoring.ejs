<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link rel="stylesheet" href="/css/style.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <!-- Background Image -->
  <div class="background-image"></div>
  
  <%- include('partials/navbar') %>
  
  <main class="main-content">
    <%- include('partials/messages') %>
    
    <section class="monitoring-section">
      <div class="monitoring-header">
        <h1 class="monitoring-title">
          <span class="status-indicator" id="statusIndicator"></span>
          <span id="monitoringStatus">MONITORING READY</span>
        </h1>
        <p class="monitoring-user">
          Operator: <span class="accent"><%= user.name %></span> • 
          <span class="material-icons" style="vertical-align: middle; font-size: 1rem;">access_time</span>
          <span id="sessionTime">00:00</span>
        </p>
      </div>

      <!-- Control Buttons -->
      <div class="monitoring-controls">
        <button id="startBtn" class="btn-primary btn-large">
          <span class="material-icons">play_arrow</span>
          START MONITORING
        </button>
        <button id="stopBtn" class="btn-danger btn-large" style="display: none;">
          <span class="material-icons">stop</span>
          STOP MONITORING
        </button>
      </div>

      <!-- Camera Feed Container - CENTERED -->
      <div class="camera-container">
        <div class="camera-feed">
          <div class="camera-overlay">
            <div class="scan-line" id="scanLine"></div>
          </div>
          <img id="cameraStream" class="camera-stream" alt="Camera Feed" style="display: none;">
          <div class="camera-placeholder" id="cameraPlaceholder">
            <div class="camera-icon">
              <span class="material-icons" style="font-size: 5rem; color: rgba(255,255,255,0.3);">videocam</span>
            </div>
            <h2 class="camera-text">CAMERA FEED READY</h2>
            <p class="camera-subtext">Click "START MONITORING" to begin surveillance</p>
          </div>
        </div>
      </div>

      <!-- Live Stats Panel -->
      <div class="stats-panel">
        <div class="stat-card">
          <div class="stat-icon">
            <span class="material-icons" style="font-size: 2.5rem; color: #00ffff;">visibility</span>
          </div>
          <div class="stat-content">
            <span class="stat-label">Gaze Direction</span>
            <span class="stat-value" id="gazeStatus">—</span>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">
            <span class="material-icons" style="font-size: 2.5rem; color: #00ffff;">face</span>
          </div>
          <div class="stat-content">
            <span class="stat-label">Faces Detected</span>
            <span class="stat-value" id="facesDetected">0</span>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">
            <span class="material-icons" style="font-size: 2.5rem; color: #00ffff;">remove_red_eye</span>
          </div>
          <div class="stat-content">
            <span class="stat-label">Total Blinks</span>
            <span class="stat-value" id="blinksCount">0</span>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">
            <span class="material-icons" style="font-size: 2.5rem; color: #ff4444;">warning</span>
          </div>
          <div class="stat-content">
            <span class="stat-label">Violations</span>
            <span class="stat-value error-color" id="violationsCount">0</span>
          </div>
        </div>
      </div>

      <!-- Risk Score Bar -->
      <div class="risk-panel">
        <h3 class="risk-title">
          <span class="material-icons">security</span>
          THREAT LEVEL ASSESSMENT
        </h3>
        <div class="risk-bar-container">
          <div class="risk-bar" id="riskBar"></div>
        </div>
        <span class="risk-value" id="riskValue">0</span>
      </div>

      <!-- Violations Log -->
      <div class="violations-panel">
        <h3 class="violations-title">
          <span class="material-icons">assignment</span>
          VIOLATIONS LOG
        </h3>
        <div class="violations-list" id="violationsList">
          <p class="no-violations">No violations detected yet</p>
        </div>
      </div>

      <!-- Download Report Section -->
      <div class="report-panel" id="reportPanel" style="display: none;">
        <h3 class="report-title">
          <span class="material-icons">description</span>
          SESSION REPORT GENERATED
        </h3>
        <div class="report-content">
          <p id="reportSummary">Session complete. Your monitoring report is ready for download.</p>
          <button id="downloadReportBtn" class="btn-primary btn-large">
            <span class="material-icons">download</span>
            DOWNLOAD REPORT
          </button>
        </div>
      </div>

    </section>
  </main>
  
  <%- include('partials/footer') %>
  
  <script>
    const socket = io();
    const userId = '<%= user._id %>';
    let isMonitoring = false;
    let currentReport = null;
    let sessionStartTime = null;
    let timerInterval = null;

    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const cameraStream = document.getElementById('cameraStream');
    const cameraPlaceholder = document.getElementById('cameraPlaceholder');
    const statusIndicator = document.getElementById('statusIndicator');
    const monitoringStatus = document.getElementById('monitoringStatus');
    const scanLine = document.getElementById('scanLine');
    const reportPanel = document.getElementById('reportPanel');
    const sessionTimeEl = document.getElementById('sessionTime');

    function updateSessionTime() {
      if (sessionStartTime) {
        const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        sessionTimeEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      }
    }

    startBtn.addEventListener('click', () => {
      startBtn.style.display = 'none';
      stopBtn.style.display = 'inline-flex';
      cameraPlaceholder.style.display = 'none';
      cameraStream.style.display = 'block';
      scanLine.style.display = 'block';
      statusIndicator.classList.add('active');
      monitoringStatus.textContent = 'MONITORING ACTIVE';
      reportPanel.style.display = 'none';
      
      sessionStartTime = Date.now();
      timerInterval = setInterval(updateSessionTime, 1000);
      
      isMonitoring = true;
      socket.emit('start-monitoring', { userId: userId });
    });

    stopBtn.addEventListener('click', () => {
      if (confirm('Are you sure you want to stop monitoring? The session report will be generated.')) {
        stopBtn.disabled = true;
        socket.emit('stop-monitoring');
      }
    });

    socket.on('detection-data', (data) => {
      if (data.type === 'frame' && data.frame) {
        cameraStream.src = 'data:image/jpeg;base64,' + data.frame;
        
        if (data.stats) {
          document.getElementById('gazeStatus').textContent = data.stats.gaze || '—';
          document.getElementById('facesDetected').textContent = data.stats.num_faces || 0;
          document.getElementById('blinksCount').textContent = data.stats.blinks || 0;
          document.getElementById('violationsCount').textContent = data.stats.violations || 0;
          
          const riskScore = data.stats.risk_score || 0;
          document.getElementById('riskValue').textContent = riskScore;
          const riskBar = document.getElementById('riskBar');
          riskBar.style.width = Math.min(riskScore, 100) + '%';
          
          if (riskScore < 25) {
            riskBar.style.background = '#00ff00';
          } else if (riskScore < 50) {
            riskBar.style.background = '#ffaa00';
          } else {
            riskBar.style.background = '#ff4444';
          }
        }
      }
      
      if (data.type === 'violation' && data.data) {
        addViolationToLog(data.data);
        showViolationAlert(data.data);
      }
      
      if (data.type === 'status') {
        monitoringStatus.textContent = data.message.toUpperCase();
      }
      
      if (data.type === 'report') {
        currentReport = data.data;
        showReportPanel(data.data);
      }
    });

    socket.on('monitoring-stopped', () => {
      stopMonitoring();
    });

    socket.on('error', (error) => {
      alert('Error: ' + error.message);
      stopMonitoring();
    });

    function stopMonitoring() {
      isMonitoring = false;
      startBtn.style.display = 'inline-flex';
      stopBtn.style.display = 'none';
      stopBtn.disabled = false;
      cameraStream.style.display = 'none';
      cameraPlaceholder.style.display = 'block';
      scanLine.style.display = 'none';
      statusIndicator.classList.remove('active');
      monitoringStatus.textContent = 'MONITORING STOPPED';
      
      if (timerInterval) {
        clearInterval(timerInterval);
      }
      
      cameraPlaceholder.querySelector('.camera-text').textContent = 'SESSION ENDED';
      cameraPlaceholder.querySelector('.camera-subtext').textContent = 'Check your report below';
    }

    function addViolationToLog(violation) {
      const violationsList = document.getElementById('violationsList');
      
      const noViolations = violationsList.querySelector('.no-violations');
      if (noViolations) {
        noViolations.remove();
      }
      
      const violationItem = document.createElement('div');
      violationItem.className = 'violation-item severity-' + violation.severity.toLowerCase();
      
      const severityBadge = document.createElement('span');
      severityBadge.className = 'severity-badge';
      severityBadge.textContent = violation.severity;
      
      const violationType = document.createElement('span');
      violationType.className = 'violation-type';
      violationType.innerHTML = `<span class="material-icons" style="font-size: 1rem; vertical-align: middle;">error_outline</span> ${violation.type}`;
      
      const violationTime = document.createElement('span');
      violationTime.className = 'violation-time';
      violationTime.textContent = violation.timestamp;
      
      violationItem.appendChild(severityBadge);
      violationItem.appendChild(violationType);
      violationItem.appendChild(violationTime);
      
      violationsList.insertBefore(violationItem, violationsList.firstChild);
      
      while (violationsList.children.length > 20) {
        violationsList.removeChild(violationsList.lastChild);
      }
    }

    function showViolationAlert(violation) {
      const alert = document.createElement('div');
      alert.className = 'floating-alert severity-' + violation.severity.toLowerCase();
      alert.innerHTML = `
        <span class="material-icons">warning</span>
        <span class="alert-text">${violation.type}</span>
      `;
      
      document.body.appendChild(alert);
      
      setTimeout(() => {
        alert.style.opacity = '0';
        setTimeout(() => alert.remove(), 300);
      }, 3500);
    }

    function showReportPanel(report) {
      reportPanel.style.display = 'block';
      
      const duration = Math.floor(report.duration_seconds / 60);
      const riskLevel = report.risk_score < 25 ? 'LOW' : report.risk_score < 50 ? 'MODERATE' : 'HIGH';
      
      document.getElementById('reportSummary').innerHTML = `
        <strong>Duration:</strong> ${duration} minutes<br>
        <strong>Total Violations:</strong> ${report.total_violations}<br>
        <strong>Risk Level:</strong> ${riskLevel}<br>
        <strong>Total Blinks:</strong> ${report.total_blinks}
      `;
    }

    document.getElementById('downloadReportBtn').addEventListener('click', () => {
      if (currentReport) {
        const dataStr = JSON.stringify(currentReport, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `exam_report_${currentReport.timestamp}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }
    });

    window.addEventListener('beforeunload', () => {
      if (isMonitoring) {
        socket.emit('stop-monitoring');
      }
    });
  </script>
</body>
</html>